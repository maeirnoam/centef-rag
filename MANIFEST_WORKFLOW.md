# Manifest and Summary Workflow

This document describes the clean, single-path workflow for managing document metadata in the CENTEF RAG system.

## Overview

The manifest (`manifest.jsonl`) is the **single source of truth** for all document metadata. It is automatically populated from document summaries generated by Gemini.

## Complete Workflow

```
Source Files (GCS)
    ↓
Ingestion Tools (ingest_*.py)
    ↓
Chunks (gs://centef-rag-chunks/data/*.jsonl)
    ↓
ingest_summaries.py --batch
    ↓
Summaries (gs://centef-rag-chunks/summaries/*.jsonl)
    ↓
populate_manifest.py
    ↓
Manifest (manifest.jsonl)
```

## Step-by-Step Guide

### 1. Ingest Documents

Use the appropriate ingestion tool for your content type:

```powershell
# PDF documents
python tools/ingest_pdf_pages.py "gs://centef-rag-bucket/data/document.pdf"

# SRT subtitle files
python tools/ingest_srt.py "gs://centef-rag-bucket/data/video.srt"

# Video files (local or GCS)
python tools/ingest_video.py "gs://centef-rag-bucket/data/video.mp4" --language ar-SA --translate-to en

# YouTube videos
python tools/ingest_youtube.py "https://www.youtube.com/watch?v=VIDEO_ID" --language en-US

# Images (diagrams, flowcharts)
python tools/ingest_image.py "gs://centef-rag-bucket/data/flowchart.jpg"
```

**Output**: Chunks written to `gs://centef-rag-chunks/data/*.jsonl`

### 2. Generate Document Summaries

Create a manifest file listing the documents you want to summarize (optional - can manually create or skip this step):

```json
{"source_id": "pdf_doc1", "chunks_uri": "gs://centef-rag-chunks/data/doc1.pdf.jsonl", "metadata": {"title": "Document Title", "author": "Author Name", "date": "2024-10"}}
```

Then generate summaries:

```powershell
# Generate summaries for all documents in manifest
python tools/ingest_summaries.py --batch --manifest manifest.jsonl

# Or generate summary for a single document
python tools/ingest_summaries.py --source-id "pdf_doc1" --title "Document Title" --author "Author Name"
```

**Output**: Summaries written to `gs://centef-rag-chunks/summaries/*.jsonl`

Each summary includes:
- 300-500 word AI-generated summary of document content
- Complete metadata (title, author, speaker, organization, date, tags)
- Links to source file and chunks
- Document statistics (num_chunks)

### 3. Populate Manifest from Summaries

**This is the single authoritative command for creating/updating the manifest:**

```powershell
python tools/populate_manifest.py
```

**Output**: `manifest.jsonl` with all document metadata extracted from summaries

The script:
1. Scans `gs://centef-rag-chunks/summaries/*.jsonl`
2. Extracts all metadata from each summary
3. Creates a complete manifest entry for each document
4. Writes to `manifest.jsonl` (or custom output path with `--output`)

### 4. Trigger Discovery Engine Import

Import chunks into Vertex AI Search:

```powershell
python tools/trigger_datastore_import.py
```

This imports all chunks from `gs://centef-rag-chunks/**/*.jsonl` into your Vertex AI Search datastore.

### 5. Search with Summaries

Search across your indexed content:

```powershell
python tools/search_with_summary.py "your search query"
```

Returns AI-generated summaries with citations and anchors (page numbers, timestamps).

## Manifest Schema

Each entry in `manifest.jsonl` contains:

### Required Fields
- `source_id`: Unique document identifier (e.g., "pdf_algorithmic_scams")
- `title`: Human-readable document title
- `document_type`: Content type (pdf|srt|youtube|video|image)
- `language`: ISO language code (en, ar, etc.)
- `source_uri`: Original file location (GCS or YouTube URL)
- `chunks_uri`: Location of chunked output
- `summary_uri`: Location of document summary
- `num_chunks`: Total number of chunks for this document

### Optional Fields (present based on document type)
- `author`: Document author (for authored content)
- `speaker`: Speaker name (for audio/video)
- `organization`: Publisher or creator organization
- `date`: Publication/recording date (YYYY-MM-DD or YYYY-MM)
- `tags`: Array of topical tags

### Example Entry

```json
{
  "source_id": "pdf_algorithmic_scams",
  "title": "Algorithmic Scams: How AI and Social Media Enable Financial Fraud",
  "document_type": "pdf",
  "language": "en",
  "source_uri": "gs://centef-rag-bucket/data/Algorithmic_Scams.pdf",
  "chunks_uri": "gs://centef-rag-chunks/data/Algorithmic_Scams.pdf.jsonl",
  "summary_uri": "gs://centef-rag-chunks/summaries/pdf_algorithmic_scams.jsonl",
  "num_chunks": 27,
  "author": "CENTEF Research Team",
  "organization": "CENTEF",
  "date": "2024-10",
  "tags": ["fraud", "AI", "social media", "financial crime"]
}
```

## Key Tools

### populate_manifest.py
**Purpose**: Single authoritative script for manifest creation  
**Input**: Summary files in `gs://centef-rag-chunks/summaries/*.jsonl`  
**Output**: `manifest.jsonl` with complete document metadata  
**Usage**: `python tools/populate_manifest.py [--output PATH]`

### ingest_summaries.py
**Purpose**: Generate AI summaries with metadata enrichment  
**Input**: Document chunks + optional manifest with metadata  
**Output**: Summary files in `gs://centef-rag-chunks/summaries/*.jsonl`  
**Model**: `gemini-2.5-flash` (preview API)  
**Usage**: 
- Batch: `python tools/ingest_summaries.py --batch --manifest manifest.jsonl`
- Single: `python tools/ingest_summaries.py --source-id ID --title TITLE`

## Two-Tier Retrieval Architecture

The manifest enables two-tier retrieval:

1. **Summaries Datastore**: Document-level search with rich metadata
2. **Chunks Datastore**: Granular chunk-level search with anchors

Benefits:
- Find relevant documents by metadata (author, date, tags, organization)
- Then drill down to specific chunks with precise anchors
- Improved ranking by combining document-level and chunk-level signals

## Regenerating from Scratch

To verify the workflow or regenerate after changes:

```powershell
# 1. Remove old manifest
Remove-Item manifest.jsonl

# 2. Regenerate from summaries
python tools/populate_manifest.py

# 3. Verify
Get-Content manifest.jsonl | ConvertFrom-Json | Select-Object source_id, title, num_chunks
```

## Notes

- The manifest is JSONL format (one JSON object per line)
- Each line is a complete, self-contained document entry
- Metadata is automatically extracted from Gemini-generated summaries
- No manual editing needed - summaries are the source of truth
- Run `populate_manifest.py` anytime summaries are updated
